<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Wallet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #87CEEB, #1e3a8a);
}

/* Header */
.header {
  background: #1e3a8a;
  color: white;
  padding: 15px;
  text-align: center;
  font-size: 20px;
}

/* Layout */
.container {
  padding: 20px;
}

/* Animated Balance Card */
.balance-card {
  background: #f3f4f6;
  border-radius: 15px;
  padding: 25px;
  text-align: center;
  margin-bottom: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  animation: floatCard 3s ease-in-out infinite;
}

@keyframes floatCard {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-6px); }
  100% { transform: translateY(0px); }
}

.balance-card h3 {
  margin: 0;
  color: #1e3a8a;
}

.balance-amount {
  font-size: 34px;
  font-weight: bold;
  color: #2563eb;
  margin-top: 10px;
}

/* Sections */
.section {
  background: #f3f4f6;
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
}

.section h4 {
  margin-top: 0;
  color: #1e3a8a;
}

input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  width: 100%;
  padding: 12px;
  background: #1e3a8a;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}

button:hover {
  background: #2563eb;
}

/* Countdown */
.timer {
  margin-top: 10px;
  font-weight: bold;
  color: red;
}

/* Transactions */
.transaction {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
}

.status-success { color: green; }
.status-pending { color: orange; }
.status-expired { color: red; }

.logout-btn {
  margin-top: 10px;
  background: gray;
}
</style>
</head>

<body>

<div class="header">My Wallet</div>

<div class="container">

  <!-- BALANCE -->
  <div class="balance-card">
    <h3>Wallet Balance</h3>
    <div class="balance-amount" id="balance">₦0</div>
  </div>

  <!-- FUND WALLET -->
  <div class="section">
    <h4>Fund Wallet</h4>
    <input type="number" id="amount" placeholder="Enter amount (₦)">
    <button onclick="generatePayment()">Generate Payment Coupon</button>
    <p id="couponInfo"></p>
    <div class="timer" id="timer"></div>
  </div>

  <!-- TRANSACTIONS -->
  <div class="section">
    <h4>Transaction History</h4>
    <div id="transactions"></div>
  </div>

  <button class="logout-btn" onclick="logout()">Logout</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyDzwnmGgEcN63RcCHSNU6p_xXKxmeqzF6k" ,
    authDomain: "losixmarket.firebaseapp.com",
    projectId: "losixmarket" ,
    storageBucket: "losixmarket.firebasestorage.app",
    messagingSenderId: "301860246689",
    appId:"1:301860246689:web:aabf0ab9af41081a91cce0",
    measurementId: "G-ZPVVZ8GNP0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let countdownInterval = null;

/* ---------------- AUTH CHECK ---------------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  currentUser = user;
  localStorage.setItem("isLoggedIn", "true");

  loadWallet();
  listenTransactions();
});

/* ---------------- LOAD WALLET ---------------- */
async function loadWallet() {
  const userDoc = await getDoc(doc(db, "users", currentUser.uid));
  if (userDoc.exists()) {
    const balance = userDoc.data().walletBalance || 0;
    document.getElementById("balance").innerText = "₦" + balance.toLocaleString();
  }
}

/* ---------------- GENERATE PAYMENT ---------------- */
window.generatePayment = async function () {
  const amount = parseFloat(document.getElementById("amount").value);
  if (!amount || amount <= 0) {
    alert("Enter valid amount");
    return;
  }

  const coupon = "TX" + Math.random().toString(36).substring(2,8).toUpperCase();
  const expiresAt = new Date(Date.now() + 15 * 60 * 1000);

  await addDoc(collection(db, "walletTransactions"), {
    uid: currentUser.uid,
    email: currentUser.email,
    amount,
    coupon,
    status: "pending",
    expiresAt,
    createdAt: new Date()
  });

  document.getElementById("couponInfo").innerHTML =
    `Transfer exactly ₦${amount}<br>
     Use narration: <b>${coupon}</b>`;

  startCountdown(expiresAt);
  document.getElementById("amount").value = "";
};

/* ---------------- COUNTDOWN ---------------- */
function startCountdown(expiryTime) {
  clearInterval(countdownInterval);

  countdownInterval = setInterval(() => {
    const now = new Date();
    const diff = expiryTime - now;

    if (diff <= 0) {
      clearInterval(countdownInterval);
      document.getElementById("timer").innerText = "Coupon Expired";
      return;
    }

    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);

    document.getElementById("timer").innerText =
      `Expires in ${minutes}m ${seconds}s`;
  }, 1000);
}

/* ---------------- TRANSACTIONS ---------------- */
function listenTransactions() {
  const q = query(
    collection(db, "walletTransactions"),
    where("uid", "==", currentUser.uid),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snapshot) => {
    const container = document.getElementById("transactions");
    container.innerHTML = "";

    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "transaction";

      div.innerHTML = `
        ₦${data.amount} - ${data.coupon}
        <br>
        <span class="status-${data.status}">
          ${data.status}
        </span>
      `;

      container.appendChild(div);
    });

    loadWallet();
  });
}

/* ---------------- FOOD DELIVERY WALLET PAYMENT ---------------- */
/* Call this function from your food delivery checkout */
window.payWithWallet = async function(orderTotal) {
  const userRef = doc(db, "users", currentUser.uid);
  const userSnap = await getDoc(userRef);
  const balance = userSnap.data().walletBalance || 0;

  if (balance < orderTotal) {
    alert("Insufficient wallet balance.");
    return false;
  }

  await updateDoc(userRef, {
    walletBalance: balance - orderTotal
  });

  await addDoc(collection(db, "walletTransactions"), {
    uid: currentUser.uid,
    email: currentUser.email,
    amount: orderTotal,
    coupon: "FOOD_ORDER",
    status: "success",
    type: "debit",
    createdAt: new Date()
  });

  alert("Payment Successful!");
  return true;
};

/* ---------------- LOGOUT ---------------- */
window.logout = async function () {
  await signOut(auth);
  localStorage.removeItem("isLoggedIn");
  window.location.href = "login.html";
};
</script>

</body>
</html>