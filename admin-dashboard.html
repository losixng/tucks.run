<!DOCTYPE html>
<html>
<head>
  <title>Admin - Payment Verification</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDzwnmGgEcN63RcCHSNU6p_xXKxmeqzF6k",
      authDomain: "losixmarket.firebaseapp.com",
      projectId: "losixmarket",
      storageBucket: "losixmarket.firebasestorage.app",
      messagingSenderId: "301860246689",
      appId: "1:301860246689:web:aabf0ab9af41081a91cce0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let allPayments = [];

    /* =========================
       REAL-TIME LISTENER
    ========================== */
    function listenPayments() {
      const q = query(collection(db, "walletTransactions"), orderBy("createdAt", "desc"));

      onSnapshot(q, snapshot => {
        allPayments = [];
        snapshot.forEach(doc => {
          allPayments.push({ id: doc.id, ...doc.data() });
        });

        renderTable();
        updateCounts();
      });
    }

    /* =========================
       RENDER TABLE
    ========================== */
    function renderTable() {
      const body = document.getElementById("paymentsBody");
      body.innerHTML = "";

      // Pending first
      const sorted = [...allPayments].sort((a, b) => {
        if (a.status === "pending" && b.status !== "pending") return -1;
        if (a.status !== "pending" && b.status === "pending") return 1;
        return 0;
      });

      sorted.forEach(p => {
        body.innerHTML += `
          <tr class="${p.status}">
            <td>${p.coupon || "-"}</td>
            <td>â‚¦${p.amount || 0}</td>
           <td>${p.expiresAt?.toDate().toLocaleString() || "-"}</td>
            <td>${p.email || "-"}</td>
            <td>${p.createdAt?.toDate().toLocaleString() || "-"}</td>
            <td>${p.status}</td>
            <td>
              ${p.status === "pending"
                ? `<button onclick="approve('${p.id}')">Approve</button>
                   <button onclick="reject('${p.id}')">Reject</button>`
                : "-"}
            </td>
          </tr>
        `;
      });
    }

    function updateCounts() {
      const pending = allPayments.filter(p => p.status === "pending").length;
      const matched = allPayments.filter(p => p.status === "matched").length;
      const rejected = allPayments.filter(p => p.status === "rejected").length;

      document.getElementById("pendingCount").innerText = pending;
      document.getElementById("approvedCount").innerText = matched;
      document.getElementById("rejectedCount").innerText = rejected;
    }

    /* =========================
       APPROVE / REJECT
    ========================== */
    window.approve = async (id) => {
      if (!confirm("Approve this payment?")) return;

      await fetch("/.netlify/functions/approvePayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ intentId: id })
      });
    };

    window.reject = async (id) => {
      if (!confirm("Reject this payment?")) return;

      await fetch("/.netlify/functions/rejectPayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ intentId: id })
      });
    };

    /* =========================
       AUTH CHECK
    ========================== */
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.replace("/login.html");
        return;
      }

      listenPayments();
    });

  </script>

  <style>
    body {
      font-family: Arial;
      background: #0f172a;
      color: white;
      padding: 20px;
    }

    h1 {
      margin-bottom: 20px;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .box {
      background: #1e293b;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      flex: 1;
    }

    table {
      width: 100%;
      background: #1e293b;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #334155;
      text-align: center;
    }

    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin: 2px;
      color: white;
    }

    button:first-child { background: #22c55e; }
    button:last-child { background: #ef4444; }

    .pending { background: rgba(255,165,0,0.1); }
    .matched { opacity: 0.6; }
    .rejected { opacity: 0.5; }
  </style>
</head>

<body>

  <h1>Payment Verification Panel</h1>

  <div class="stats">
    <div class="box">Pending<br><h2 id="pendingCount">0</h2></div>
    <div class="box">Approved<br><h2 id="approvedCount">0</h2></div>
    <div class="box">Rejected<br><h2 id="rejectedCount">0</h2></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Coupon</th>
        <th>Amount</th>
        <th>Expires</th>
        <th>User Email</th>
        <th>Date</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="paymentsBody"></tbody>
  </table>

</body>
</html>