<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tucks Food Delivery</title>
<style>
:root{
  --bg:#0b0f1a; --card:#12172a; --accent:#00ffd5; --accent2:#7a7cff;
  --danger:#ff5d5d; --text:#e8ebff; --muted:#9aa1ff;
}
body{
  margin:0;font-family:Poppins;
  background:radial-gradient(1200px 600px at 10% -10%, #1b2150, transparent),var(--bg);
  color:var(--text);min-height:100vh;
  display:flex;justify-content:center;padding:20px
}
.container{max-width:1000px;width:100%}
h1{text-align:center;margin-bottom:6px}
.sub{text-align:center;color:var(--muted);margin-bottom:16px}

.card{
  background:linear-gradient(180deg,#151b38,#0f1430);
  border-radius:22px;padding:22px;margin-top:20px;
  display:block
}

form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.full{grid-column:1/-1}
label{font-size:12px;color:var(--muted)}
input,select{
  width:100%;padding:12px 14px;border-radius:14px;
  border:1px solid #242b66;background:#0b1030;color:var(--text)
}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #242b66;padding:10px;text-align:center}
th{color:var(--accent)}

.total{margin-top:12px;font-weight:600}

button{
  padding:14px 22px;border-radius:999px;border:none;
  font-weight:600;cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  position:relative;
}
button:disabled{opacity:.6;cursor:not-allowed}

.spinner{
  width:20px;height:20px;border:3px solid #2a31ff;
  border-top-color:transparent;border-radius:50%;
  animation:spin 1s linear infinite;display:inline-block;margin-left:10px;
}
@keyframes spin{to{transform:rotate(360deg)}}

.popup {
  position:fixed;top:20px;right:-400px;padding:15px 20px;border-radius:10px;
  background:var(--danger);box-shadow:0 5px 20px rgba(0,0,0,0.4);
  transition:0.5s;color:white;font-weight:600;
}
.popup.show{right:20px;}
.popup.success{background:green;}
.balanceFlash{animation:flash 0.6s ease;}
@keyframes flash{
  0%{background:var(--card);}
  50%{background:green;}
  100%{background:var(--card);}
}
</style>
</head>
<body>

<div class="container">

<h1>Food Delivery</h1>
<div class="sub">Get your food delivered to your door step for just â‚¦250 and â‚¦50 transfer fee</div>

<div class="card">
<form id="orderForm">

<table>
<thead>
<tr><th>Item</th><th>Qty</th><th>Price</th></tr>
</thead>
<tbody id="orderTable">
<tr>
<td><input class="item" list="productList"></td>
<td><input class="qty" type="number" value="1" min="1"></td>
<td><input class="price" value="0" readonly></td>
</tr>
</tbody>
</table>
<datalist id="productList"></datalist>
<button type="button" onclick="addRow()">+ Add item</button>

<div class="full total" id="total">Total: â‚¦0</div>

<!-- Wallet / Receipt -->
<div class="full">
<label>Payment Method:</label>
<div style="display:flex;gap:10px;margin-top:6px">
  <label><input type="radio" name="paymentType" value="wallet" checked> Wallet</label>
  <label><input type="radio" name="paymentType" value="receipt"> Upload Receipt</label>
</div>
</div>

<div class="full" id="receiptBox" style="display:none">
<label style="color: yellow;">Upload receipt</label>
<input type="file" id="receipt" accept="image/*">
</div>

<div class="full">
<button id="submitBtn">Submit Order</button>
</div>
</form>
</div>
</div>

<div class="popup" id="popup"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, doc, runTransaction } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

const firebaseConfig = { 
  apiKey: "AIzaSyDzwnmGgEcN63RcCHSNU6p_xXKxmeqzF6k" ,
    authDomain: "losixmarket.firebaseapp.com",
    projectId: "losixmarket" ,
    storageBucket: "losixmarket.firebasestorage.app",
    messagingSenderId: "301860246689",
    appId:"1:301860246689:web:aabf0ab9af41081a91cce0",
    measurementId: "G-ZPVVZ8GNP0"
 };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser=null;
onAuthStateChanged(auth,user=>{if(!user) window.location.href="login.html"; else currentUser=user;});

const PRODUCTS=[
  {name:"Jollof Rice",price:250},{name:"Jollof Spaghetti",price:250},
  {name:"Fried Rice",price:2600},{name:"White Rice & Stew",price:2400},
  {name:"White Spaghetti & Stew",price:250},{name:"Chicken",price:1500},
  {name:"Beef",price:1000},{name:"Turkey",price:1800},
  {name:"Moi Moi",price:800},{name:"Soft Drink",price:500}
];

const productList=document.getElementById("productList");
PRODUCTS.forEach(p=>{const o=document.createElement("option");o.value=p.name;productList.appendChild(o);});

function addRow(){
  document.getElementById("orderTable").insertAdjacentHTML("beforeend",`
    <tr>
      <td><input class="item" list="productList"></td>
      <td><input class="qty" type="number" value="1" min="1"></td>
      <td><input class="price" value="0" readonly></td>
    </tr>`);
}
window.addRow=addRow;

function calcTotal(){
  let sum=0;
  document.querySelectorAll("#orderTable tr").forEach(r=>{
    const qty=+r.querySelector(".qty").value||0;
    const price=+r.querySelector(".price").value||0;
    sum+=qty*price;
  });
  document.getElementById("total").textContent="Total: â‚¦"+sum;
}

document.addEventListener("input",e=>{
  if(e.target.classList.contains("item")){
    const r=e.target.closest("tr");
    const prod=PRODUCTS.find(p=>p.name.toLowerCase()===e.target.value.toLowerCase());
    r.querySelector(".price").value=prod?prod.price:0;
  }
  calcTotal();
});

const paymentRadios=document.querySelectorAll('input[name="paymentType"]');
const receiptBox=document.getElementById("receiptBox");
paymentRadios.forEach(r=>{
  r.addEventListener("change",()=>{
    receiptBox.style.display=r.value==="receipt"?"block":"none";
    document.getElementById("receipt").required=r.value==="receipt";
  });
});
document.querySelector('input[name="paymentType"]:checked').dispatchEvent(new Event('change'));

const submitBtn=document.getElementById("submitBtn");
const popup=document.getElementById("popup");

function showPopup(msg,success=false){popup.textContent=msg;popup.classList.add("show");if(success)popup.classList.add("success");setTimeout(()=>{popup.classList.remove("show");popup.classList.remove("success");},3000);}

document.getElementById("orderForm").onsubmit=async e=>{
  e.preventDefault();
  const totalText=document.getElementById("total").textContent;
  const total=+totalText.replace("Total: â‚¦","");
  const paymentMethod=document.querySelector('input[name="paymentType"]:checked').value;
  submitBtn.disabled=true;
  submitBtn.innerHTML='<span class="spinner"></span> Processing...';

  if(paymentMethod==="wallet"){
    try{
      const userRef=doc(db,"users",currentUser.uid);
      const ordersRef=collection(db,"foodOrders");
      const transRef=collection(db,"walletTransactions");
      await runTransaction(db,async t=>{
        const uSnap=await t.get(userRef);
        if(!uSnap.exists()) throw "Wallet not found";
        const walletBalance=uSnap.data().walletBalance||0;
        if(walletBalance<total) throw "Insufficient wallet balance";
        t.update(userRef,{walletBalance:walletBalance-total});
        const orderRef=doc(ordersRef);
        t.set(orderRef,{
          items:Array.from(document.querySelectorAll("#orderTable tr")).map(r=>({
            item:r.querySelector(".item").value,
            qty:+r.querySelector(".qty").value||1,
            price:+r.querySelector(".price").value||0
          })),
          total,paymentMethod:"wallet",status:"paid",
          createdAt:serverTimestamp(),userId:currentUser.uid
        });
        const newTrans=doc(transRef);
        t.set(newTrans,{userId:currentUser.uid,type:"debit",amount:total,description:"Food order payment",createdAt:serverTimestamp()});
      });
      document.querySelector(".container").classList.add("balanceFlash");
      showPopup("Order placed successfully ðŸŽ‰",true);
      document.getElementById("orderTable").innerHTML=`<tr>
        <td><input class="item" list="productList"></td>
        <td><input class="qty" type="number" value="1" min="1"></td>
        <td><input class="price" value="0" readonly></td>
      </tr>`;
      calcTotal();
    }catch(err){
      showPopup(err);
    }
  }else{
    const receiptFile=document.getElementById("receipt").files[0];
    if(!receiptFile){showPopup("Please upload receipt");submitBtn.disabled=false;submitBtn.innerHTML="Submit Order";return;}
    await addDoc(collection(db,"foodOrders"),{
      items:Array.from(document.querySelectorAll("#orderTable tr")).map(r=>({
        item:r.querySelector(".item").value,
        qty:+r.querySelector(".qty").value||1,
        price:+r.querySelector(".price").value||0
      })),
      total,paymentMethod:"receipt",status:"pending",
      createdAt:serverTimestamp(),userId:currentUser.uid
    });
    showPopup("Receipt submitted for verification",true);
    document.getElementById("orderTable").innerHTML=`<tr>
      <td><input class="item" list="productList"></td>
      <td><input class="qty" type="number" value="1" min="1"></td>
      <td><input class="price" value="0" readonly></td>
    </tr>`;
    calcTotal();
  }

  submitBtn.disabled=false;
  submitBtn.innerHTML="Submit Order";
};
</script>
</body>
</html>